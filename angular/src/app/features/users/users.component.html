<div class="users-container">
  <div class="page-header">
    <h1>User Management</h1>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="toggleCreateForm()">
        <mat-icon>add</mat-icon>
        Add User
      </button>
      <button mat-stroked-button (click)="loadUsers()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="statistics-grid" *ngIf="statistics">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>people</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ statistics.totalUsers || 0 }}</h3>
            <p>Total Users</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon active">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ statistics.activeUsers || 0 }}</h3>
            <p>Active Users</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon risk">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ statistics.highRiskUsers || 0 }}</h3>
            <p>High Risk Users</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon fraud">
            <mat-icon>security</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ statistics.usersWithFraudHistory || 0 }}</h3>
            <p>Fraud History</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Search and Filters -->
  <mat-card class="search-card">
    <mat-card-content>
      <div class="search-row">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search Users</mat-label>
          <input matInput [(ngModel)]="searchTerm" placeholder="Search by username, email, name...">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        <button mat-raised-button color="primary" (click)="onSearch()">
          <mat-icon>search</mat-icon>
          Search
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- User Creation Form -->
  <mat-card class="create-form-card" *ngIf="showCreateForm">
    <mat-card-header>
      <mat-card-title>Create New User</mat-card-title>
      <mat-card-subtitle>Add a new user to the system</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="userForm" (ngSubmit)="onCreateUser()">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Username</mat-label>
            <input matInput formControlName="username" placeholder="Enter username">
            <mat-error *ngIf="userForm.get('username')?.hasError('required')">Username is required</mat-error>
            <mat-error *ngIf="userForm.get('username')?.hasError('minlength')">Username must be at least 3 characters</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input matInput formControlName="email" type="email" placeholder="Enter email">
            <mat-error *ngIf="userForm.get('email')?.hasError('required')">Email is required</mat-error>
            <mat-error *ngIf="userForm.get('email')?.hasError('email')">Please enter a valid email</mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Password</mat-label>
            <input matInput formControlName="password" type="password" placeholder="Enter password">
            <mat-error *ngIf="userForm.get('password')?.hasError('required')">Password is required</mat-error>
            <mat-error *ngIf="userForm.get('password')?.hasError('minlength')">Password must be at least 6 characters</mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>First Name</mat-label>
            <input matInput formControlName="firstName" placeholder="Enter first name">
            <mat-error *ngIf="userForm.get('firstName')?.hasError('required')">First name is required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Last Name</mat-label>
            <input matInput formControlName="lastName" placeholder="Enter last name">
            <mat-error *ngIf="userForm.get('lastName')?.hasError('required')">Last name is required</mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Date of Birth</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="birthDate" 
                   [max]="maxDate" [min]="minDate"
                   placeholder="Select date of birth">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-hint>Enter the user's date of birth</mat-hint>
            <mat-error *ngIf="userForm.get('birthDate')?.hasError('required')">
              Date of birth is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>User Type</mat-label>
            <mat-select formControlName="userType">
              <mat-option value="CUSTOMER">Customer</mat-option>
              <mat-option value="ADMIN">Admin</mat-option>
              <mat-option value="FRAUD_ANALYST">Fraud Analyst</mat-option>
              <mat-option value="SUPPLIER">Supplier</mat-option>
              <mat-option value="NURSE">Nurse</mat-option>
              <mat-option value="DELIVERY_MAN">Delivery Man</mat-option>
              <mat-option value="TECHNICAL_SUPPORT">Technical Support</mat-option>
            </mat-select>
          </mat-form-field>

          <div class="checkbox-group">
            <mat-checkbox formControlName="isActive">Active</mat-checkbox>
            <mat-checkbox formControlName="isVerified">Verified</mat-checkbox>
          </div>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit" [disabled]="userForm.invalid || loading">
            <mat-icon>save</mat-icon>
            Create User
          </button>
          <button mat-stroked-button type="button" (click)="toggleCreateForm()">
            <mat-icon>cancel</mat-icon>
            Cancel
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Users Table -->
  <mat-card class="users-card">
    <mat-card-header>
      <mat-card-title>Users</mat-card-title>
      <mat-card-subtitle>Manage system users and their permissions</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <app-data-table
        [columns]="columns"
        [data]="users"
        [loading]="loading"
        [pageSize]="pageSize"
        [pageSizeOptions]="[5, 10, 25, 50]"
        [showEditButton]="isAdmin"
        [showDeleteButton]="isAdmin"
        (edit)="onEdit($event)"
        (delete)="onDelete($event)"
        (view)="onView($event)">
        
        <!-- Custom cell templates -->
        <ng-container matColumnDef="riskProfile">
          <th mat-header-cell *matHeaderCellDef>Risk Profile</th>
          <td mat-cell *matCellDef="let user">
            <span class="risk-profile" [style.color]="getRiskProfileColor(user.riskProfile)">
              {{ user.riskProfile }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="isActive">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let user">
            <mat-chip [color]="user.isActive ? 'primary' : 'warn'">
              <mat-icon>{{ user.isActive ? 'check_circle' : 'cancel' }}</mat-icon>
              {{ user.isActive ? 'Active' : 'Inactive' }}
            </mat-chip>
          </td>
        </ng-container>
      </app-data-table>
    </mat-card-content>
  </mat-card>
</div>
